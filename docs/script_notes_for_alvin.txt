
##### SEALOG SCRIPT NOTES #####
Author: Webb Pinner, webbpinner@gmail.com
Written: May 6, 2018
Updated: May 6, 2018



# PRE-CRUISE

## This is run from seaplay server on sci net (.161.55)

token='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjVhZWIxZDIxZjVhZjc0MTA0NzZkNGMwZSIsInNjb3BlIjpbImFkbWluIiwiY3J1aXNlX21hbmFnZXIiLCJldmVudF9tYW5hZ2VyIiwiZXZlbnRfbG9nZ2VyIiwiZXZlbnRfd2F0Y2hlciJdLCJpYXQiOjE1MjU2MDkwNjZ9.S5xuesc384upsBKOx0yMvgH6_zF2XWlow4SnCNb1uRM'
framegrab_folder="/mnt/dataDisk/framegrabs"
seaplay_server_ip="199.92.162.55"

echo "Delete framegrabs from last cruise"
rm -f ${framegrab_folder}/*

echo "Resetting SeaPlay Database"
curl -X DELETE --header 'Accept: application/json' --header 'authorization: '${token} 'http://'${seaplay_server_ip}':8000/seaplay-server/api/v1/cruises/all'

curl -X DELETE --header 'Accept: application/json' --header 'authorization: '${token} 'http://'${seaplay_server_ip}':8000/seaplay-server/api/v1/lowerings/all'

curl -X DELETE --header 'Accept: application/json' --header 'authorization: '${token} 'http://'${seaplay_server_ip}':8000/seaplay-server/api/v1/events/all'


# PRE-DIVE:

## This is run from the Alvin c+c machine (199.92.162.100)

token='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjU5ODFmMTY3MjEyYjM0OGFlZDdmYTlmNSIsInNjb3BlIjpbImFkbWluIiwiZXZlbnRfbWFuYWdlciIsImV2ZW50X2xvZ2dlciIsImV2ZW50X3dhdGNoZXIiXSwiaWF0IjoxNTI1NjA0NzA3fQ.C1oHe_FEWRIwHU3AE8yBz0FlBia8BJnDVHQ4H-qtGc'
backup_folder=
dive_num=
framegrab_folder="/home/alvin/framegrabs"

echo "Turn off ASNAP"
curl -X PATCH --header 'Content-Type: application/json' --header 'Accept: application/json' --header 'authorization: '${token} -d '{
  "custom_var_name": "asnapStatus",
  "custom_var_value": "Off"
}' 'http://localhost:8000/sealog-server/api/v1/custom_vars/59810167212b348aed7fa9f5'

echo "Wipe local database"
curl -X DELETE --header 'Accept: application/json' --header 'authorization: '${token} 'http://localhost:8000/sealog-server/api/v1/events/all'

echo "Move framegrabs to backup folder"
mkdir ${backup_folder}/${dive_num}/framegrabs
mv ${framegrab_folder}/* ${backup_folder}/${dive_num}/framegrabs/



# POST-DIVE:

## This is run from Alvin c+c machine (199.92.162.100)

token='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjU5ODFmMTY3MjEyYjM0OGFlZDdmYTlmNSIsInNjb3BlIjpbImFkbWluIiwiZXZlbnRfbWFuYWdlciIsImV2ZW50X2xvZ2dlciIsImV2ZW50X3dhdGNoZXIiXSwiaWF0IjoxNTI1NjA0NzA3fQ.C1oHe_FEWRIwHU3AE8yBz0FlBia8BJnDVHQ4H-qtGc'
backup_folder=
dive_num=
framegrab_folder="/home/alvin/framegrabs"
sealog_server_ip="199.92.162.100"

echo "Turn off ASNAP"
curl -X PATCH --header 'Content-Type: application/json' --header 'Accept: application/json' --header 'authorization: '${token} -d '{
  "custom_var_name": "asnapStatus",
  "custom_var_value": "Off"
}' 'http://'${sealog_server_ip}':8000/sealog-server/api/v1/custom_vars/59810167212b348aed7fa9f5'

echo "Export event data"
curl -X GET --header 'Accept: application/json' --header 'authorization: '${token} --output '${backup_folder}/${dive_num}/${dive_num}_eventOnlyExport.json' 'http://'${sealog_server_ip}':8000/sealog-server/api/v1/events'

echo "Export aux data"
curl -X GET --header 'Accept: application/json' --header 'authorization: '${token} --output '{backup_folder}/${dive_num}/${dive_num}_auxDataExport.json' 'http://'${sealog_server_ip}':8000/sealog-server/api/v1/event_aux_data'

echo "Export data as json"
curl -X GET --header 'Accept: application/json' --header 'authorization: '${token} --output '{backup_folder}/${dive_num}/${dive_num}_sealogExport.csv' 'http://'${sealog_server_ip}':8000/sealog-server/api/v1/event_exports'

echo "Export data as csv"
curl -X GET --header 'Accept: application/json' --header 'authorization: '${token} --output '{backup_folder}/${dive_num}/${dive_num}_sealogExport.csv' 'http://'${sealog_server_ip}':8000/sealog-server/api/v1/event_exports?format=csv'

mkdir ${backup_folder}/${dive_num}/framegrabs
scp alvin@${sealog_server_ip}:/${framegrab_folder}/* ${backup_folder}/${dive_num}/framegrabs


## This is run from alvindata02

token='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjU5ODFmMTY3MjEyYjM0OGFlZDdmYTlmNSIsInNjb3BlIjpbImFkbWluIiwiZXZlbnRfbWFuYWdlciIsImV2ZW50X2xvZ2dlciIsImV2ZW50X3dhdGNoZXIiXSwiaWF0IjoxNTI1NjA0NzA3fQ.C1oHe_FEWRIwHU3AE8yBz0FlBia8BJnDVHQ4H-qtGc'
backup_folder=
dive_num=
framegrab_folder="/mnt/dataDisk/framegrabs"
seaplay_server_ip="199.92.162.55"

echo "Copy framegrabs to seaplay server"
scp ${cruise_data_folder}/sealog/${dive_num}/framegrabs alvin@${seaplay-server}:${framegrab_folder}



# POST LAST DIVE OF CRUISE

## This is run from alvindata02

token='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjU5ODFmMTY3MjEyYjM0OGFlZDdmYTlmNSIsInNjb3BlIjpbImFkbWluIiwiZXZlbnRfbWFuYWdlciIsImV2ZW50X2xvZ2dlciIsImV2ZW50X3dhdGNoZXIiXSwiaWF0IjoxNTI1NjA0NzA3fQ.C1oHe_FEWRIwHU3AE8yBz0FlBia8BJnDVHQ4H-qtGc'
backup_folder=
cruise_num=
seaplay_server_ip="199.92.162.55"
alvindata01_user=
alvindata01_IP=
alvindata01_backup_folder=

echo "Export the cruise metadata record"
curl -X GET --header 'Accept: application/json' --header 'authorization: '${token} --output '{backup_folder}/${cruise_num}/sealog/${cruise_num}_sealogCruiseRecordExport.json' 'http://'${seaplay_server_ip}':8000/seaplay-server/api/v1/cruises'

echo "Export the lowering metadata record"
curl -X GET --header 'Accept: application/json' --header 'authorization: '${token} --output '{backup_folder}/${cruise_num}/sealog/${cruise_num}_sealogLoweringRecordsExport.json' 'http://'${seaplay_server_ip}':8000/seaplay-server/api/v1/lowerings'

echo "Copying data to alvindata01"
scp {backup_folder}/${cruise_num}/sealog/${cruise_num}_sealogCruiseRecordExport.json ${alvindata01_user}@${alvindata01_ip}:/${alvindata01_backup_folder}/${cruise_num}/sealog/

scp {backup_folder}/${cruise_num}/sealog/${cruise_num}_sealogLoweringRecordsExport.json ${alvindata01_user}@${alvindata01_ip}:/${alvindata01_backup_folder}/${cruise_num}/sealog/

